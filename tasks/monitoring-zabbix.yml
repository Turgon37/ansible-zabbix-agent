---

- name: Install block device discovery script file
  copy:
    src:   devices.discovery.py
    dest:  "{{ zabbix_agent__custom_scripts_directory|d('/opt/zabbix-agent-scripts') }}/common_devices_discovery.py"
    owner: root
    group: root
    mode:  0755

- name: Configure zabbix userparameters
  include_role:
    name: zabbix-common
    tasks_from: userparameter
  vars:
    zabbix_common__userparameter:
      name: common
      userparameter:
        - key: conntrack.count
          command: >
            /bin/bash -c "if [ -f /proc/net/ip_conntrack ]; then wc -l < /proc/net/ip_conntrack; else echo -n 0; fi"
          sudo: True
          comment: 'fetch current conntrack size'
        - key: conntrack.max
          command: >
            /bin/bash -c "VALUE=$(/sbin/sysctl net.ipv4.netfilter.ip_conntrack_max --ignore | awk '{print $3}'); echo ${VALUE:-0}"
          sudo: True
          comment: 'fetch maximum size of conntrack'
        - key: disk.discovery
          command: "{{ zabbix_agent__custom_scripts_directory|d('/opt/zabbix-agent-scripts') }}/common_devices_discovery.py{% for e in zabbix_agent__common_devices_discovery_excludes %} --exclude {{ e }}{% endfor %}"
          comment: 'discovery for block devices'
      state: present
